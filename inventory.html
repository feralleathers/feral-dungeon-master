<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Feral Dungeon Master â€” Inventory</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1113;--p1:#15181b;--p2:#1b1f24;--txt:#e8e8e8;--mut:#a7a7a7;--line:#262b31;--accent:#c73a3a}
*{box-sizing:border-box} body{margin:0;background:#0f1113;color:var(--txt);font-family:"Playfair Display",serif}
.wrap{max-width:1100px;margin:0 auto;padding:18px}
h1{margin:0 0 12px;font-size:26px}
.top{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
.btn{border:1px solid var(--line);background:#15181b;color:#eee;border-radius:10px;padding:8px 12px;cursor:pointer;font:700 12px/1 system-ui}
.btn.red{border-color:#6f1a1a;background:#c73a3a}
.panel{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:12px}
.grid{display:grid;grid-template-columns:260px 1fr;gap:12px}
.catlist .cat{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);background:#12161a;color:#ddd;border-radius:10px;padding:10px 12px;margin-bottom:8px;cursor:pointer}
.cat.active{border-color:#5a1a1a;background:#1a0f10;color:#fff}
.search{display:flex;gap:8px;margin-bottom:8px}
.inp,select,textarea{width:100%;border:1px solid #2a3036;background:#0f1418;color:#eee;border-radius:8px;padding:8px 10px;font:600 12px system-ui}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #20252b;padding:8px 6px;text-align:left;font:600 12px system-ui}
.table th{color:#cfcfcf}
.rowbtn{display:inline-flex;gap:6px}
.small{font:600 12px/1.3 system-ui;color:#cfcfcf}
.drop{border:2px dashed #323840;border-radius:12px;padding:12px;text-align:center;margin-top:8px}
.drop.over{border-color:#8f2a2a;background:#130d0e}
.badge{display:inline-block;border:1px solid #30363d;border-radius:999px;padding:3px 8px;margin-left:8px;font:700 11px system-ui;background:#13181c;color:#c9c9c9}
a{color:#ffc4c4}
hr{border:0;border-top:1px solid #22282f;margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>Feral Dungeon Master â€” Inventory Catalog</h1>
    <div style="display:flex;gap:8px;align-items:center">
      <a class="btn" href="index.html">ðŸŽ› Scene Designer</a>
      <a class="btn" href="hypnosis.html">ðŸŒ€ Hypnotics</a>
      <a class="btn" href="inventory.html">ðŸ”„ Refresh</a>
    </div>
  </div>

  <div class="panel" style="margin-bottom:12px">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div style="flex:1;min-width:280px">
        <div class="small">Current profile name</div>
        <input id="profName" class="inp" placeholder="e.g., Titus â€” Master Dungeon">
      </div>
      <button class="btn" id="saveProf">Save name</button>
      <button class="btn" id="loadDemo">Load demo profile</button>
      <button class="btn" id="expCSV">Download CSV</button>
      <button class="btn red" id="expJSON">Download profile (.json)</button>
    </div>
  </div>

  <div class="grid">
    <!-- Left: Categories + Upload -->
    <div class="panel">
      <div class="small" style="margin-bottom:8px">Browse by category</div>
      <div id="cats" class="catlist"></div>
      <hr>
      <div class="small">Upload profile (CSV/JSON)</div>
      <div class="drop" id="drop">
        Drag a <b>.csv</b> or <b>.json</b> file here<br>
        or <label style="text-decoration:underline;cursor:pointer"><input type="file" id="file" accept=".csv,.json" style="display:none">browse</label>
      </div>
      <div class="small" style="margin-top:8px">
        CSV header (sample):<br>
        <code>id,name,cat,zones,safety,access</code><br>
        zones/access: comma-separated (e.g., <code>NECK_FRONT, TORSO_OVERALL_FRONT</code>)
      </div>
    </div>

    <!-- Right: Items -->
    <div class="panel">
      <div class="search">
        <input id="q" class="inp" placeholder="Search nameâ€¦">
        <select id="selCat" class="inp"></select>
      </div>
      <table class="table" id="tbl">
        <thead>
          <tr><th style="width:36%">Name</th><th>Category</th><th>Zones</th><th>Access</th><th style="width:120px"></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px;text-align:right">
        <button class="btn" id="addBtn">+ Add Item</button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit modal -->
<div id="modal" style="display:none;position:fixed;inset:0;background:#0008;align-items:center;justify-content:center;z-index:50">
  <div class="panel" style="max-width:640px;width:92%">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <b id="mtitle" style="font:700 16px system-ui">Add Item</b>
      <button class="btn" id="mclose">Ã—</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">
      <div><div class="small">Name</div><input id="mname" class="inp" placeholder="e.g., No-gasm Pro (locking)"></div>
      <div><div class="small">Category</div><select id="mcat" class="inp"></select></div>
      <div style="grid-column:1 / span 2"><div class="small">Target Zones (comma-separated)</div><input id="mzones" class="inp" placeholder="NECK_FRONT, TORSO_OVERALL_FRONT"></div>
      <div style="grid-column:1 / span 2"><div class="small">Safety Notes (one per line)</div><textarea id="msafe" class="inp" placeholder="Bolt cutters within reach? yes"></textarea></div>
      <div style="grid-column:1 / span 2">
        <div class="small">Access Options</div>
        <label><input type="checkbox" class="acc" value="NIPPLES"> nipple access</label>
        &nbsp; <label><input type="checkbox" class="acc" value="CROTCH"> crotch access</label>
        &nbsp; <label><input type="checkbox" class="acc" value="REAR"> rear access</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:space-between;margin-top:10px">
      <button class="btn" id="mdel" style="display:none">Delete</button>
      <div>
        <button class="btn" id="mcancel">Cancel</button>
        <button class="btn red" id="msave">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Analytics shim -->
<script>
(function(){
  const KEY='fdm_analytics_queue';
  function loadQ(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]') }catch(e){ return [] } }
  function saveQ(q){ localStorage.setItem(KEY, JSON.stringify(q)) }
  window.fdmTrack = function(event, props={}){
    const payload = { t: Date.now(), app:'FDM', url: location.pathname, evt: event, props };
    const q = loadQ(); q.push(payload); saveQ(q);
    console.log('[FDM]', event, props);
  };
  fdmTrack('page_view', { page: 'inventory' });
})();
</script>

<script>
/* ========= Categories ========= */
const CATS = [
  "Toys (Anal)","Toys (Oral)","Outfits","Restraints","Furniture",
  "Sensations","E-stim","Safety","Machines","All"
];

/* ========= Local storage ========= */
const INV_KEY = "fdm_inventory";
const PROFNAME_KEY = "fdm_profile_name";

function loadINV(){
  try{ const x = JSON.parse(localStorage.getItem(INV_KEY)||"[]"); if(Array.isArray(x)) return x }catch(e){}
  return [
    {id:"nogasm",name:"No-gasm Trainer",cat:"Machines",zones:["GROIN","TORSO_OVERALL_FRONT"],safety:["Use lowest setting initially"],config:{access:["CROTCH"]}},
    {id:"thrustpro",name:"Thrusting Machine Pro",cat:"Machines",zones:["GROIN","ANUS"],safety:["Secure mounting; emergency stop reachable"]},
    {id:"velcuffs",name:"Velcro Cuffs (easy-release)",cat:"Restraints",zones:["FOREARM_LEFT","FOREARM_RIGHT"],safety:["Safety scissors reachable"]}
  ];
}
let INV = loadINV();
function saveINV(){ localStorage.setItem(INV_KEY, JSON.stringify(INV)); }

function loadProfName(){ return localStorage.getItem(PROFNAME_KEY)||"" }
function saveProfName(v){ localStorage.setItem(PROFNAME_KEY, v||"") }

/* ========= UI helpers ========= */
const $=(id)=>document.getElementById(id);
function zonesStr(z){ return (z||[]).join(", "); }
function accessStr(i){ return (i.config?.access||[]).join(", "); }
function findIndex(id){ return INV.findIndex(x=>x.id===id); }

/* ========= Category list ========= */
let activeCat = "Restraints";
function renderCats(){
  const box = $("cats"); box.innerHTML="";
  CATS.forEach((c)=>{
    const div = document.createElement("div");
    div.className = "cat"+(c===activeCat?" active":"");
    div.innerHTML = `<span>${c}</span>${c==="Machines"?'<span class="badge">new</span>':""}`;
    div.onclick = ()=>{ activeCat=c; $("selCat").value=c; renderTable(); renderCats(); };
    box.appendChild(div);
  });
}

/* ========= Search/select ========= */
function setupSearch(){
  const sel = $("selCat");
  sel.innerHTML = CATS.map(c=>`<option>${c}</option>`).join("");
  sel.value = activeCat;
  sel.onchange = ()=>{ activeCat = sel.value; renderCats(); renderTable(); };
  $("q").oninput = ()=>renderTable();

  // profile name
  $("profName").value = loadProfName();
  $("saveProf").onclick = ()=>{ saveProfName($("profName").value.trim()); fdmTrack('prof_name_save', {name:$("profName").value.trim()}); };
  $("loadDemo").onclick = loadDemoProfile;
}

/* ========= Table ========= */
function renderTable(){
  const q = $("q").value.toLowerCase().trim();
  const rows = $("tbl").querySelector("tbody"); rows.innerHTML="";

  INV.filter(x=>{
    const catOK = activeCat==="All" ? true : x.cat===activeCat;
    const qOK = !q || (x.name.toLowerCase().includes(q));
    return catOK && qOK;
  }).forEach(x=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${x.name}</td>
      <td>${x.cat}</td>
      <td>${zonesStr(x.zones)}</td>
      <td>${accessStr(x)}</td>
      <td>
        <div class="rowbtn">
          <button class="btn" data-ed="${x.id}">Edit</button>
          <button class="btn" data-dup="${x.id}">Duplicate</button>
          <button class="btn" data-del="${x.id}">Delete</button>
        </div>
      </td>`;
    rows.appendChild(tr);
  });

  rows.querySelectorAll("[data-ed]").forEach(b=> b.onclick=()=>openModal(INV[findIndex(b.dataset.ed)]));
  rows.querySelectorAll("[data-del]").forEach(b=> b.onclick=()=>delItem(b.dataset.del));
  rows.querySelectorAll("[data-dup]").forEach(b=> b.onclick=()=>dupItem(b.dataset.dup));
}

/* ========= Modal ========= */
const modal = $("modal"), mtitle=$("mtitle"), mclose=$("mclose"), mcancel=$("mcancel"), msave=$("msave"), mdel=$("mdel");
const mname=$("mname"), mcat=$("mcat"), mzones=$("mzones"), msafe=$("msafe");
let editingId = null;

(function fillCatSelect(){ mcat.innerHTML = CATS.filter(c=>c!=="All").map(c=>`<option>${c}</option>`).join(""); })();

function openModal(item){
  if(item){
    editingId = item.id;
    mtitle.textContent = "Edit Item";
    mname.value = item.name || "";
    mcat.value = item.cat || "Restraints";
    mzones.value = (item.zones||[]).join(", ");
    msafe.value = (item.safety||[]).join("\n");
    modal.querySelectorAll(".acc").forEach(cb=> cb.checked = !!(item.config?.access||[]).includes(cb.value));
    mdel.style.display = "inline-block";
  }else{
    editingId = null;
    mtitle.textContent = "Add Item";
    mname.value = ""; mcat.value = activeCat==="All" ? "Restraints" : activeCat;
    mzones.value = ""; msafe.value = "";
    modal.querySelectorAll(".acc").forEach(cb=>cb.checked=false);
    mdel.style.display = "none";
  }
  modal.style.display = "flex";
}
function closeModal(){ modal.style.display = "none"; }
mclose.onclick = closeModal; mcancel.onclick = closeModal;

function normalizeFromModal(){
  const name = mname.value.trim();
  const cat = mcat.value;
  const zones = mzones.value.split(",").map(s=>s.trim()).filter(Boolean);
  const safety = msafe.value.split("\n").map(s=>s.trim()).filter(Boolean);
  const acc = [...modal.querySelectorAll(".acc:checked")].map(cb=>cb.value);
  if(!name) { alert("Enter a name"); return null; }
  const id = (editingId || name.toLowerCase().replace(/[^a-z0-9]+/g,"-")).slice(0,40);
  const cfg = acc.length ? { config:{access:acc} } : {};
  return { id, name, cat, zones, safety, ...cfg };
}
msave.onclick = ()=>{
  const item = normalizeFromModal();
  if(!item) return;
  const i = INV.findIndex(x=>x.id===item.id);
  if(i>=0) INV[i]=item; else INV.push(item);
  saveINV(); closeModal(); renderTable();
  fdmTrack('inv_save', { id:item.id, cat:item.cat });
};
mdel.onclick = ()=>{
  if(!editingId) return;
  const i = INV.findIndex(x=>x.id===editingId);
  if(i>=0){ INV.splice(i,1); saveINV(); closeModal(); renderTable(); fdmTrack('inv_delete', { id:editingId }); }
};

/* ========= Row utils ========= */
function delItem(id){
  const i = findIndex(id);
  if(i<0) return;
  if(confirm("Delete this item?")) { INV.splice(i,1); saveINV(); renderTable(); fdmTrack('inv_delete', { id }); }
}
function dupItem(id){
  const i = findIndex(id); if(i<0) return;
  const src = INV[i];
  const copy = JSON.parse(JSON.stringify(src));
  copy.id = (src.id+"-copy").slice(0,40);
  copy.name = src.name+" (copy)";
  INV.splice(i+1,0,copy); saveINV(); renderTable(); fdmTrack('inv_duplicate', { id:src.id });
}

/* ========= Import/Export ========= */
function toCSV(){
  const lines = [["id","name","cat","zones","safety","access"]];
  INV.forEach(i=>{
    lines.push([
      i.id,
      i.name.replaceAll('"','""'),
      i.cat,
      (i.zones||[]).join("; "),
      (i.safety||[]).join("; ").replaceAll('"','""'),
      (i.config?.access||[]).join("; ")
    ]);
  });
  return lines.map(r=>r.map(v=> /[",;\n]/.test(String(v)) ? `"${String(v)}"` : String(v)).join(",")).join("\n");
}
function fromCSV(text){
  const rows = text.replace(/\r/g,"").split("\n").filter(Boolean);
  const hdr = rows.shift().toLowerCase();
  if(!/id,?name,?cat/.test(hdr)) throw new Error("CSV header must start with: id,name,cat,zones,safety,access");
  const out=[];
  rows.forEach(line=>{
    const cells=[]; let cur="", q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"' ){ if(line[i+1]==='"'){cur+='"';i++;} else {q=!q;} continue; }
      if(ch===',' && !q){ cells.push(cur); cur=""; continue; }
      cur+=ch;
    }
    cells.push(cur);
    const [id,name,cat,zones,safety,access] = cells;
    out.push({
      id: (id||"").trim() || name.toLowerCase().replace(/[^a-z0-9]+/g,"-").slice(0,40),
      name: (name||"").trim(),
      cat: (cat||"").trim() || "Restraints",
      zones: (zones||"").split(/[;,]/).map(s=>s.trim()).filter(Boolean),
      safety: (safety||"").split(/[;,]/).map(s=>s.trim()).filter(Boolean),
      ...(access? {config:{access: access.split(/[;,]/).map(s=>s.trim()).filter(Boolean)}} : {})
    });
  });
  return out;
}
function download(name, blob){
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
}
$("expCSV").onclick = ()=>{ download("fdm_inventory.csv", new Blob([toCSV()], {type:"text/csv"})); fdmTrack('inv_export_csv', {}); };
$("expJSON").onclick = ()=>{
  const payload = { profileName: $("profName").value.trim()||null, items: INV };
  download("fdm_inventory.json", new Blob([JSON.stringify(payload,null,2)], {type:"application/json"}));
  fdmTrack('inv_export_json', {});
};

const drop = $("drop"), file = $("file");
drop.addEventListener("dragover",(e)=>{e.preventDefault(); drop.classList.add("over");});
drop.addEventListener("dragleave",()=>drop.classList.remove("over"));
drop.addEventListener("drop",(e)=>{
  e.preventDefault(); drop.classList.remove("over");
  const f = e.dataTransfer.files[0]; if(!f) return; importFile(f);
});
file.onchange = ()=>{ if(file.files[0]) importFile(file.files[0]); };

function importFile(f){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      let incoming = [];
      if(f.name.toLowerCase().endsWith(".json")){
        const data = JSON.parse(reader.result);
        const items = Array.isArray(data) ? data : (Array.isArray(data.items)? data.items : []);
        if(!Array.isArray(items)) throw new Error("JSON must be an array or {items:[...]}");
        if(data.profileName) { $("profName").value = data.profileName; saveProfName(data.profileName); }
        incoming = items;
      }else{
        incoming = fromCSV(reader.result);
      }
      incoming.forEach(it=>{
        const idx = INV.findIndex(x=>x.id===it.id);
        if(idx>=0) INV[idx]=it; else INV.push(it);
      });
      saveINV(); renderTable();
      alert(`Imported ${incoming.length} item(s).`);
      fdmTrack('inv_import', { count: incoming.length });
    }catch(err){
      alert("Import failed: " + err.message);
    }
  };
  reader.readAsText(f);
}

/* ========= Demo profile ========= */
function loadDemoProfile(){
  const demo = [
    {id:"locking-collar",name:"Leather Collar (locking)",cat:"Restraints",zones:["NECK_FRONT","NECK_REAR"],safety:["Key check"]},
    {id:"velcuffs",name:"Velcro Cuffs",cat:"Restraints",zones:["FOREARM_LEFT","FOREARM_RIGHT"],safety:["Safety scissors reachable"]},
    {id:"rope-10m",name:"Rope (10m)",cat:"Restraints",zones:["TORSO_OVERALL_FRONT"],safety:["Cutting tool nearby"]},
    {id:"jacket",name:"Bondage Jacket",cat:"Outfits",zones:["TORSO_OVERALL_FRONT","TORSO_OVERALL_BACK"],safety:["Circulation checks"]},
    {id:"wax",name:"Wax Play",cat:"Sensations",zones:["CHEST","ABS"]},
    {id:"thrustpro",name:"Thrusting Machine Pro",cat:"Machines",zones:["GROIN","ANUS"],safety:["Emergency stop reachable"]}
  ];
  INV = demo.slice(); saveINV(); renderTable();
  if(!$("profName").value){ $("profName").value="Demo â€” FDM Showcase"; saveProfName($("profName").value); }
  alert("Demo profile loaded.");
  fdmTrack('demo_profile_load', {});
}

/* ========= Add button ========= */
$("addBtn").onclick = ()=>openModal(null);

/* ========= Init ========= */
renderCats(); setupSearch(); renderTable();
</script>
</body>
</html>
